#!/bin/bash
#
##DOC:	stop all (nodejs) apps in current profile.

function yac_main {
	[ ! -f "${PROFILE_APP_LISTFILE}" ] && INFO "missing ${PROFILE_APP_LISTFILE} for stopping all apps" && return 1
	source ${YAC_LIB_DIR}/system

	local APPS=($(tac ${PROFILE_APP_LISTFILE}))
	for app in "${APPS[@]}" ; do
		local MONITOR_PID_FILE=$(GET_DAEMON_CONFIG ${app} ppid_file)
		[ ! -f "${MONITOR_PID_FILE}" ] && INFO "$(LIGHT_GREEN ${app}): missing ppid file => ${MONITOR_PID_FILE}" && continue
		local MONITOR_PID=$(cat ${MONITOR_PID_FILE})
		[ "" == "${MONITOR_PID}" ] && INFO "$(LIGHT_GREEN ${app}): empty ppid file ${MONITOR_PID_FILE}" && continue
		INFO "$(LIGHT_GREEN ${app}): kill bash monitor process (pid: $(PURPLE ${MONITOR_PID}))"
		kill ${MONITOR_PID}

		local APP_PID_FILE=$(GET_DAEMON_CONFIG ${app} pid_file)
		[ ! -f "${APP_PID_FILE}" ] && INFO "$(LIGHT_GREEN ${app}): missing pid file => ${APP_PID_FILE}" && continue
		local APP_PID=$(cat ${APP_PID_FILE})
		[ "" == "${APP_PID}" ] && INFO "$(LIGHT_GREEN ${app}): empty pid file ${APP_PID_FILE}" && continue
		INFO "$(LIGHT_GREEN ${app}): kill app process (pid: $(PURPLE ${APP_PID}))"
		#
		# [todo] in the future, yapps shall exit with 230 code, then all daemon
		#        monitor scripts will exit automatically. No need to kill them.
		#
		kill ${APP_PID}
	done
}
