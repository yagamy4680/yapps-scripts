#!/bin/bash

function init-yac-variables {
	TMP=$(pwd)
	cd $(dirname $0)
	cd ../
	export YAC_DIR=$(pwd)
	export YAC_BIN_DIR="${YAC_DIR}/bin"
	export YAC_LIB_DIR="${YAC_DIR}/helpers"
	cd ${TMP}

	[ "" == "${BOARD_PROFILE}" ] && export BOARD_PROFILE=$(cat /etc/environment | grep "^BOARD_PROFILE" | awk -F'=' '{print $2}')
	[ "" == "${YS_DIR}" ] && export BOARD_PROFILE=$(cat /etc/environment | grep "^YS_DIR" | awk -F'=' '{print $2}')

	export BOARD_PROFILE_VERSION=$(cat /mnt/app/profiles/${BOARD_PROFILE}/entry)
	export PROFILE_ROOT="/${BOARD_PROFILE}"
	export PROFILE_LOG_DIR="${PROFILE_ROOT}/logs"
	export PROFILE_LOG_SYS_DIR="${PROFILE_LOG_DIR}/system"
	export PROFILE_LOG_APP_DIR="${PROFILE_LOG_DIR}/app"
	export PROFILE_STORAGE_DIR="${PROFILE_ROOT}/storage"

	export PROFILE_CURRENT_DIR="${PROFILE_ROOT}/current"
	export PROFILE_CURRENT_LOG_DIR="${PROFILE_CURRENT_DIR}/logs"

	[ "" == "${NODEJS_VERSION}" ] && export NODEJS_VERSION=$(cat ${YS_DIR}/defaults.conf | grep "^nodejs" | awk -F'\t' '{print $2}')
	[ "" == "${PYTHON_VERSION}" ] && export PYTHON_VERSION=$(cat ${YS_DIR}/defaults.conf | grep "^python" | awk -F'\t' '{print $2}')
	[ "" == "${ARCHIVE_URL}" ] && export ARCHIVE_URL=$(cat ${YS_DIR}/cloud.conf | grep "^ARCHIVE_URL" | awk -F'\t' '{print $2}')
	[ "" == "${RELEASE_URL}" ] && export RELEASE_URL=$(cat ${YS_DIR}/cloud.conf | grep "^RELEASE_URL" | awk -F'\t' '{print $2}')
	[ "" == "${RELEASE_USER}" ] && export RELEASE_USER=$(cat ${YS_DIR}/cloud.conf | grep "^RELEASE_USER" | awk -F'\t' '{print $2}')
	[ "" == "${RELEASE_PASS}" ] && export RELEASE_PASS=$(cat ${YS_DIR}/cloud.conf | grep "^RELEASE_PASS" | awk -F'\t' '{print $2}')

	export RUNTIME_DIR="/mnt/app/runtimes"

	if [ "default" == "${NODEJS_VERSION}" ]; then
		# When using system default nodejs pacakge, then 
		# using `nodenv` to get the version and path of installed
		# nodejs package.
		#
		# If `nodenv` is not setup yet, needs to activate 
		# /opt/dotfiles/.bashrc
		#
		[ "" == "${HOME}" ] && export HOME=/root && INFO ""
		[ "" == "${NODENV_SHELL}" ] && export PATH="/root/.nodenv/bin:$PATH" && eval "$(nodenv init -)"
		[ "" == "${NODENV_SHELL}" ] && INFO "missing nodenv!!" && exit 1
		local VERSION=$(nodenv version | awk '{print $1}')
		local NODEDIR=$(dirname $(nodenv which node))
		INFO "[default] nodejs.version = $(LIGHT_GREEN ${VERSION})"
		INFO "[default] nodejs.path = $(LIGHT_GREEN ${NODEDIR})"
		cd ${NODEDIR} && cd ..
		export RUNTIME_NODEJS_DIR=$(pwd)
		export NODEJS_VERSION=${VERSION}
		cd ${TMP}
	else
		[ "" == "${RUNTIME_NODEJS_DIR}" ] && export RUNTIME_NODEJS_DIR="${RUNTIME_DIR}/nodejs/${NODEJS_VERSION}"
	fi

	export RUNTIME_DIR="/mnt/app/runtimes"
	[ "" == "${RUNTIME_PYTHON_DIR}" ] && export RUNTIME_PYTHON_DIR="${RUNTIME_DIR}/python/${PYTHON_VERSION}"

	export NODEJS_MODULE_DIR="${PROFILE_CURRENT_DIR}/runtimes/nodejs/${NODEJS_VERSION}"
}
